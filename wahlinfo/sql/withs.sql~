
---------------------------------------------------------------
-- Schritt 0 - Berechne Aggregate
---------------------------------------------------------------

-- Berechne die anzahl an erhaltenen stimmen pro kandidat
with StimmenCountKandidatSimple as (
         select s.kandidat_id, count(*) as stimmenAnzahl
         from stimme s
         group by s.kandidat_id

)
, StimmenCountKandidat as (
         select k.id as kandidat_id, k.partei_id, k.wahlkreis_id, d.stimmenAnzahl
         from StimmenCountKandidatSimple d, Kandidat k
         where d.kandidat_id = k.id
         and k.id <> 0
)

-- Berechne die anzahl an erhaltenen stimmen pro partei
, StimmenCountParteiSimple as (
         select s.partei_id, count(*) as Anzahl
         from stimme s
         group by s.partei_id
)
, StimmenCountPartei as (
         select *
         from StimmenCountParteiSimple
         where partei_id <> 0
)
, ZweitStimmenGesammt as (
         select sum(z2.Anzahl)
         from StimmenCountPartei z2
)

---------------------------------------------------------------
-- Schritt 1 - Berechne die Sitzplatzverteilung im Bundestag --
---------------------------------------------------------------

-- Berechne die gewinner in jedem wahlkreis
, Direktmandate as ( -- RFI fuck monetdb ..
         select d.kandidat_id, d.partei_id, d.wahlkreis_id
         from StimmenCountKandidat d
         where not exists ( select * from StimmenCountKandidat d2
                           where d2.stimmenAnzahl > d.stimmenAnzahl
                           and d2.kandidat_id <> d.kandidat_id -- WTF ?!
                           and d2.wahlkreis_id = d.wahlkreis_id)
)

-- Zaehlt die Anzahl der Direktmandate pro Partei
, AnzahlDirektmandatePartei as (
        select a.partei_id, count(*) as Anzahl
        from Direktmandate a
        group by a.partei_id
)

-- Anteil der Zweitstimmen pro Partei in % (Gesamtdeutschland)
, AnteilZweitStimmen as (
         select z.partei_id, (sum(z.Anzahl)*100.0)/(select * from ZweitStimmenGesammt) as Anteil
         from StimmenCountPartei z
         where z.partei_id <> 0
         group by z.partei_id
)

-- Findet die Parteien die in den Bundestag gelangen
-- Anteil der Zweitstimmen Partei unter Beruecksichtigung der Sperrklausel (mind. 5% oder drei Direktmandate)
, AnteilZweitStimmenSperrklausel as (
        select *
        from AnteilZweitStimmen a
        where a.Anteil >= 5
        or 3 <= (select ad.Anzahl from AnzahlDirektmandatePartei ad where ad.partei_id = a.partei_id)
)

-- Skaliere die %-Werte der Parteien, die in den bundestag kommen, auf 100% skalieren
, ProzentualeSitzverteilungImBundestag as (
        select a.partei_id, (select 1/(sum(b.Anteil)/100) from AnteilZweitStimmenSperrklausel b)*a.Anteil as Anteil
        from AnteilZweitStimmenSperrklausel a
)

-------------------------------------------------------
-- Schritt 2 - Verteile die Sitzplaetze nach d'Hondt --
-------------------------------------------------------

-- Anzahl der Direktmandate ohne Partei im Bundestag haben (schlieÃŸt auch parteilose Kandidaten mit ein)
, AnzDirektmandateOhneBundestagspartei as (
        select count(*) as Anzahl
        from Direktmandate d
        where d.partei_id not in
                (select a.partei_id from ProzentualeSitzverteilungImBundestag a)
)

-- Verfahren nach d'Hondt: Proportionale Verteilung der Zweitstimmen auf die Sitze im Bundestag (ganze Sitze und Rest-Anteile)
-- Verteile die ganzzahligen Sitze sofort
-- Die restlichen n Sitzplaetze werden dann den Parteien mit den hoechsten Nachkommastellen zugewiesen
, PropVerteilungSitzeBundestag as (
        select partei_id, anteil, cast(anteil*(598-(select Anzahl from AnzDirektmandateOhneBundestagspartei)) as integer)/100 as sitze, (((anteil*598)%100)/100) as rest
        from ProzentualeSitzverteilungImBundestag
)

-- Berechne die Anzahl der noch zu vergebenden Sitze
, AnzZuVergebendeSitze as (
        select 598-sum(sitze) as Anzahl
        from PropVerteilungSitzeBundestag
)

-- Eine RowId hinzufuegen um die obersten n Rest anteile zu finden
, PropVerteilungSitzeBundestagRowId as (
        select partei_id, anteil, sitze, rest, ROW_NUMBER () OVER (ORDER BY rest DESC) AS rowNum
        from PropVerteilungSitzeBundestag
)
-- Verbleibende Sitze entsprechend der Rest-Anteile vergeben
, ParteienBeguenstigt as (
        select v.partei_id as partei_id2
        from PropVerteilungSitzeBundestagRowId v
        where v.rowNum <= (select a.Anzahl from AnzZuVergebendeSitze a)
)

-- Endgueltige Sitzverteilung (beguenstigte Parteien erhalten einen zusaetzlichen Sitz)
-- Ordnet jeder Partei die Anzahl von Sitzen zu
, SitzVerteilung as (
        select v.partei_id, (case when b.partei_id2 is null then v.sitze else v.sitze+1 end) as sitze -- TODO: geht nicht, jede partei bekommt einen sitz dazu
        from PropVerteilungSitzeBundestag v
        left outer join ParteienBeguenstigt b on v.partei_id = b.partei_id2
)

-- check point =)
-- hier sind die sitze jeder partei auf die bundeslaender verteilt
-- select sum(sitze) from SitzVerteilung; -- == 601

/*
select * from PropVerteilungSitzeBundestag;
select * from ParteienBeguenstigt;
select * from ParteienBeguenstigt b right outer join PropVerteilungSitzeBundestag v on v.partei_id = b.partei_id2; -- does not contain any null values WTF
*/

---------------------------------------------------------------------
-- Schritt 3 - Verteile die Sitze pro Partei auf die Bundeslaender --
---------------------------------------------------------------------
-- Jede partei hat nun eine Anzahl von Sitzen zugewiesen bekommen. (in SitzVerteilung)
-- Diese muessen nun fuer jede Partei auf die Listenkandidaten aus den Bundeslaendern gemappt werden.
-- Dazu wird in diesem Schritt fuer jede Partei (mit dem d'Hondt) berechnet welches Bundesland wieviele sitze bekommt.

-- Anzahl der Zweitstimmen pro Bundesland pro Partei
, AnzZweitstimmenBundesland as (
        select k.bundesland_id, s.partei_id, count(*) as Anzahl
        from stimme s, wahlkreis k
        where s.partei_id <> 0
        and s.wahlkreis_id = k.id
        group by k.bundesland_id, s.partei_id
)

-- Zaehlt die Anzahl der Direktmandate pro Bundesland pro Partei
, AnzDirektmandateBundeslandPartei as (
        select w.bundesland_id, d.partei_id, count(*) as Anzahl
        from Direktmandate d, wahlkreis w
        where d.wahlkreis_id = w.id
        group by w.bundesland_id, d.partei_id
)

-- Anteil der Stimmen pro Bundesland an den Gesamtstimmen einer Partei in %
-- Wie sind die Stimmen der Partei ueber die Bundeslaender verteilt
, AnteilZweitstimmenBundeslandPartei as (
        select a.partei_id, a.bundesland_id, a.anzahl, (a.anzahl*100.0)/(select sum(Anzahl) from AnzZweitstimmenBundesland b where a.partei_id = b.partei_id group by b.partei_id) as Anteil
        from AnzZweitstimmenBundesland a, SitzVerteilung b
        where a.partei_id = b.partei_id -- only use partys in the bundestag
)

-- Verfahren nach d'Hondt: Proportionale Verteilung der Zweitstimmen pro Bundesland auf die Sitze einer Partei
-- Ordne Sitzplaetze auf die Bundeslaender zu (ohne rest)
, PropVerteilungSitzeBundesland as (
        select a.partei_id, a.bundesland_id, a.anteil, cast(anteil*(select s.sitze from SitzVerteilung s where a.partei_id = s.partei_id) as integer)/100 as sitze, (((a.anteil*(select s.sitze from SitzVerteilung s where a.partei_id = s.partei_id))%100)/100) as rest
        from AnteilZweitstimmenBundeslandPartei a
)

-- Anzahl der noch zu vergebenden Sitze pro Partei.
-- Berechnet pro Bundesland pro Partei weiviele Sitze noch durch den rest offen sind.
, AnzahlZuVergebendeSitzePartei as (
        select p.partei_id, sum(p.sitze) as SitzeBereitsVergeben, (select s.sitze from SitzVerteilung s where p.partei_id = s.partei_id)-SitzeBereitsVergeben as SitzeZuVergeben
        from PropVerteilungSitzeBundesland p
        group by p.partei_id
)

-- Eine RowId hinzufuegen um den rest den obersten n Parteien geben zu koennen.
, PropVerteilungSitzeBundeslandMitRowid as (
        select *, ROW_NUMBER () OVER (ORDER BY partei_id, rest DESC) AS rowNum
        from PropVerteilungSitzeBundesland
)

-- Die row id war bis jetzt nur global, diese muss aber lokal fuer jede Partei berechnet werden.
, PropVerteilungSitzeBundeslandMitRowidLokal as (
        select p1.partei_id, p1.bundesland_id, p1.anteil, p1.sitze, p1.rest, p1.rowNum - min(p2.rowNum) + 1 as rowNum
        from PropVerteilungSitzeBundeslandMitRowid p1, PropVerteilungSitzeBundeslandMitRowid p2
        where p1.partei_id = p2.partei_id
        group by p1.partei_id, p1.bundesland_id, p1.anteil, p1.sitze, p1.rest, p1.rowNum
)

-- Berechne fuer jede Partei in welchen Bundeslaendern sie durch den rest noch einen Sitz bekommt.
-- Diese Tabelle enthaelt fuer Jede Partei die Bundelaender die noch einen Sitz bekommen.
, BeguenstigteBundeslandParteien as (
        select a.partei_id as partei_id, p.bundesland_id as bundesland_id
        from AnzahlZuVergebendeSitzePartei a, PropVerteilungSitzeBundeslandMitRowidLokal p
        where a.partei_id = p.partei_id
        and p.rowNum <= a.SitzeZuVergeben
)

-- Addiere die bonus sitze entsprechend hinzu.
, SitzeProBundeslandProPartei as (
        select p.partei_id, p.bundesland_id, (case when b.partei_id is null then p.sitze else p.sitze+1 end) as sitze
        from PropVerteilungSitzeBundesland p left outer join BeguenstigteBundeslandParteien b on p.partei_id=b.partei_id and p.bundesland_id=b.bundesland_id
)

select partei_id, sum(sitze) from SitzeProBundeslandProPartei group by partei_id;

